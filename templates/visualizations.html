{% extends "base.html" %}

{% block title %}Visualizations | Wearable Insight Generator{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold mb-2">Data Visualizations</h1>
    <p class="text-gray-600">Explore your health metrics and discover patterns in your data.</p>
</div>

<!-- Time Range Selector -->
<div class="bg-white rounded-xl shadow-md p-4 mb-6">
    <div class="flex flex-wrap items-center justify-between">
        <div class="flex space-x-2 mb-2 sm:mb-0">
            <button class="px-3 py-1 text-sm bg-indigo-600 text-white rounded-full">7d</button>
            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition">30d</button>
            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition">90d</button>
            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition">1y</button>
            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition">Custom</button>
        </div>
        <div class="flex space-x-2">
            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition flex items-center">
                <i class="fas fa-download mr-1"></i> Export
            </button>
            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition flex items-center">
                <i class="fas fa-share-alt mr-1"></i> Share
            </button>
        </div>
    </div>
</div>

<!-- Main Visualization Area -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Metrics Selection Sidebar -->
    <div class="bg-white rounded-xl shadow-md p-4 lg:col-span-1">
        <h2 class="text-lg font-semibold mb-4">Metrics</h2>
        
        <div class="space-y-4">
            <!-- Recovery Metrics -->
            <div>
                <h3 class="text-sm font-semibold text-gray-500 mb-2">RECOVERY</h3>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="hrv" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="hrv" class="ml-2 text-sm text-gray-700">Heart Rate Variability (HRV)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="rhr" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="rhr" class="ml-2 text-sm text-gray-700">Resting Heart Rate</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="readiness" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="readiness" class="ml-2 text-sm text-gray-700">Readiness Score</label>
                    </div>
                </div>
            </div>
            
            <!-- Sleep Metrics -->
            <div>
                <h3 class="text-sm font-semibold text-gray-500 mb-2">SLEEP</h3>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="sleepDuration" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="sleepDuration" class="ml-2 text-sm text-gray-700">Sleep Duration</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="deepSleep" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="deepSleep" class="ml-2 text-sm text-gray-700">Deep Sleep</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="remSleep" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="remSleep" class="ml-2 text-sm text-gray-700">REM Sleep</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="sleepScore" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="sleepScore" class="ml-2 text-sm text-gray-700">Sleep Quality Score</label>
                    </div>
                </div>
            </div>
            
            <!-- Activity Metrics -->
            <div>
                <h3 class="text-sm font-semibold text-gray-500 mb-2">ACTIVITY</h3>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="steps" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="steps" class="ml-2 text-sm text-gray-700">Steps</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="activeMinutes" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="activeMinutes" class="ml-2 text-sm text-gray-700">Active Minutes</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="calories" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="calories" class="ml-2 text-sm text-gray-700">Calories Burned</label>
                    </div>
                </div>
            </div>
            
            <!-- Workout Metrics -->
            <div>
                <h3 class="text-sm font-semibold text-gray-500 mb-2">WORKOUTS</h3>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="workoutDuration" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="workoutDuration" class="ml-2 text-sm text-gray-700">Workout Duration</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="workoutIntensity" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="workoutIntensity" class="ml-2 text-sm text-gray-700">Workout Intensity</label>
                    </div>
                </div>
            </div>
            
            <!-- Insight Markers -->
            <div class="pt-4 border-t border-gray-200">
                <h3 class="text-sm font-semibold text-gray-500 mb-2">INSIGHTS</h3>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="showInsights" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="showInsights" class="ml-2 text-sm text-gray-700">Show Insight Markers</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="correlationLines" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="correlationLines" class="ml-2 text-sm text-gray-700">Show Correlation Lines</label>
                    </div>
                </div>
            </div>
            
            <!-- Apply Button -->
            <div class="pt-4">
                <button class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                    Apply Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Visualization Panel -->
    <div class="bg-white rounded-xl shadow-md p-4 lg:col-span-2">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Time-Series Visualization</h2>
            <div class="flex space-x-2">
                <button class="px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 transition">
                    <i class="fas fa-chart-line mr-1"></i> Line
                </button>
                <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition">
                    <i class="fas fa-chart-bar mr-1"></i> Bar
                </button>
                <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition">
                    <i class="fas fa-chart-area mr-1"></i> Area
                </button>
            </div>
        </div>
        
        <!-- Main Chart -->
        <div id="mainChart" class="w-full h-96 mb-4"></div>
        
        <!-- Insight Cards Below Chart -->
        <div>
            <h3 class="text-sm font-semibold text-gray-500 mb-3">INSIGHTS FROM THIS DATA</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                    <div class="flex items-start">
                        <div class="bg-indigo-100 rounded-full p-2 mr-3 flex-shrink-0">
                            <i class="fas fa-lightbulb text-indigo-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-indigo-900">Sleep impacts HRV recovery</h4>
                            <p class="text-xs text-indigo-700 mt-1">Your HRV increases by an average of 12% following nights with 7+ hours of sleep.</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <div class="flex items-start">
                        <div class="bg-blue-100 rounded-full p-2 mr-3 flex-shrink-0">
                            <i class="fas fa-chart-line text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-blue-900">Activity trend detected</h4>
                            <p class="text-xs text-blue-700 mt-1">Your activity levels are consistently higher on weekdays compared to weekends.</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-purple-50 rounded-lg border border-purple-100">
                    <div class="flex items-start">
                        <div class="bg-purple-100 rounded-full p-2 mr-3 flex-shrink-0">
                            <i class="fas fa-moon text-purple-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-purple-900">Sleep quality correlation</h4>
                            <p class="text-xs text-purple-700 mt-1">Screen time after 10pm correlates with 18% reduction in deep sleep.</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-green-50 rounded-lg border border-green-100">
                    <div class="flex items-start">
                        <div class="bg-green-100 rounded-full p-2 mr-3 flex-shrink-0">
                            <i class="fas fa-check text-green-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-green-900">Recovery optimization</h4>
                            <p class="text-xs text-green-700 mt-1">Rest days after high-intensity workouts improve recovery by 25%.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Correlation Analysis -->
<div class="bg-white rounded-xl shadow-md p-6 mt-6">
    <h2 class="text-lg font-semibold mb-4">Metric Correlation Analysis</h2>
    <p class="text-gray-600 mb-4">Discover how different metrics influence each other over time.</p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Correlation Matrix -->
        <div>
            <h3 class="text-sm font-semibold text-gray-500 mb-3">CORRELATION MATRIX</h3>
            <div id="correlationMatrix" class="w-full h-64"></div>
        </div>
        
        <!-- Scatter Plot -->
        <div>
            <h3 class="text-sm font-semibold text-gray-500 mb-3">SCATTER ANALYSIS</h3>
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center">
                    <span class="text-sm text-gray-700 mr-2">X-Axis:</span>
                    <select class="border border-gray-300 rounded-lg px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option>Sleep Duration</option>
                        <option>HRV</option>
                        <option>Steps</option>
                        <option>Resting Heart Rate</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <span class="text-sm text-gray-700 mr-2">Y-Axis:</span>
                    <select class="border border-gray-300 rounded-lg px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option>HRV</option>
                        <option>Sleep Duration</option>
                        <option>Steps</option>
                        <option>Resting Heart Rate</option>
                    </select>
                </div>
            </div>
            <div id="scatterPlot" class="w-full h-64"></div>
        </div>
    </div>
</div>

<!-- Saved Visualizations -->
<div class="bg-white rounded-xl shadow-md p-6 mt-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Saved Visualizations</h2>
        <button class="px-3 py-1 text-sm bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition">
            <i class="fas fa-save mr-1"></i> Save Current View
        </button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Saved Visualization 1 -->
        <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition">
            <div class="h-32 bg-gray-100 flex items-center justify-center">
                <img src="/static/images/viz-recovery.png" alt="Recovery Trends" class="w-full h-full object-cover">
            </div>
            <div class="p-3">
                <h3 class="font-medium">Recovery Trends</h3>
                <p class="text-xs text-gray-500">Last 30 days of HRV and sleep data</p>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs text-gray-400">Saved 2 days ago</span>
                    <button class="text-indigo-600 hover:text-indigo-800 transition">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Saved Visualization 2 -->
        <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition">
            <div class="h-32 bg-gray-100 flex items-center justify-center">
                <img src="/static/images/viz-workout.png" alt="Workout Impact" class="w-full h-full object-cover">
            </div>
            <div class="p-3">
                <h3 class="font-medium">Workout Impact</h3>
                <p class="text-xs text-gray-500">Correlation between workouts and recovery</p>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs text-gray-400">Saved 1 week ago</span>
                    <button class="text-indigo-600 hover:text-indigo-800 transition">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Saved Visualization 3 -->
        <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition">
            <div class="h-32 bg-gray-100 flex items-center justify-center">
                <img src="/static/images/viz-sleep.png" alt="Sleep Patterns" class="w-full h-full object-cover">
            </div>
            <div class="p-3">
                <h3 class="font-medium">Sleep Patterns</h3>
                <p class="text-xs text-gray-500">Sleep stages and quality analysis</p>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs text-gray-400">Saved 2 weeks ago</span>
                    <button class="text-indigo-600 hover:text-indigo-800 transition">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create the main chart
        createMainChart();
        
        // Create the correlation matrix
        createCorrelationMatrix();
        
        // Create the scatter plot
        createScatterPlot();
    });
    
    function createMainChart() {
        // Sample data
        const dates = ['2025-03-22', '2025-03-23', '2025-03-24', '2025-03-25', '2025-03-26', '2025-03-27', '2025-03-28'];
        const hrv = [65, 67, 62, 58, 52, 55, 58];
        const rhr = [52, 51, 53, 56, 58, 57, 55];
        const sleep = [7.2, 7.5, 6.8, 5.9, 5.7, 7.8, 7.5];
        const steps = [8500, 9200, 12000, 11500, 9800, 7500, 10400];
        
        // Create traces for each metric
        const traces = [
            {
                x: dates,
                y: hrv,
                name: 'HRV',
                line: {color: '#4F46E5', width: 3},
                yaxis: 'y'
            },
            {
                x: dates,
                y: rhr,
                name: 'Resting HR',
                line: {color: '#F59E0B', width: 3},
                yaxis: 'y2'
            },
            {
                x: dates,
                y: sleep,
                name: 'Sleep (hours)',
                line: {color: '#8B5CF6', width: 3},
                yaxis: 'y3'
            }
        ];
        
        // Add insight markers
        const insights = [
            {date: '2025-03-24', type: 'warning', text: 'High strain detected'},
            {date: '2025-03-26', type: 'alert', text: 'Sleep quality decreased'},
            {date: '2025-03-27', type: 'positive', text: 'Recovery improving'}
        ];
        
        insights.forEach(insight => {
            let color = '#4F46E5';
            if (insight.type === 'warning') color = '#F59E0B';
            if (insight.type === 'alert') color = '#EF4444';
            if (insight.type === 'positive') color = '#10B981';
            
            traces.push({
                x: [insight.date],
                y: [hrv[dates.indexOf(insight.date)]],
                mode: 'markers',
                marker: {
                    size: 12,
                    color: color,
                    symbol: 'circle',
                    line: {
                        color: 'white',
                        width: 2
                    }
                },
                showlegend: false,
                hoverinfo: 'text',
                text: insight.text,
                yaxis: 'y'
            });
        });
        
        // Layout configuration
        const layout = {
            grid: {
                rows: 3,
                columns: 1,
                pattern: 'independent',
                roworder: 'top to bottom'
            },
            yaxis: {
                title: 'HRV',
                titlefont: {color: '#4F46E5'},
                tickfont: {color: '#4F46E5'}
            },
            yaxis2: {
                title: 'Resting HR',
                titlefont: {color: '#F59E0B'},
                tickfont: {color: '#F59E0B'}
            },
            yaxis3: {
                title: 'Sleep (hours)',
                titlefont: {color: '#8B5CF6'},
                tickfont: {color: '#8B5CF6'}
            },
            margin: {
                l: 50,
                r: 50,
                t: 20,
                b: 50
            },
            hovermode: 'closest',
            showlegend: true,
            legend: {
                orientation: 'h',
                y: -0.2
            }
        };
        
        // Create the plot
        Plotly.newPlot('mainChart', traces, layout, {responsive: true});
    }
    
    function createCorrelationMatrix() {
        // Sample correlation data
        const z = [
            [1.0, 0.7, 0.5, -0.3],
            [0.7, 1.0, 0.4, -0.2],
            [0.5, 0.4, 1.0, 0.1],
            [-0.3, -0.2, 0.1, 1.0]
        ];
        
        const labels = ['HRV', 'Sleep', 'Activity', 'RHR'];
        
        const data = [{
            z: z,
            x: labels,
            y: labels,
            type: 'heatmap',
            colorscale: 'Viridis',
            showscale: false,
            hoverongaps: false
        }];
        
        const layout = {
            margin: {
                l: 50,
                r: 50,
                t: 20,
                b: 50
            }
        };
        
        Plotly.newPlot('correlationMatrix', data, layout, {responsive: true});
    }
    
    function createScatterPlot() {
        // Sample data
        const sleep = [7.2, 7.5, 6.8, 5.9, 5.7, 7.8, 7.5, 6.9, 7.1, 6.5, 7.0, 7.3, 6.7, 5.8];
        const hrv = [65, 67, 62, 58, 52, 55, 58, 60, 63, 59, 61, 64, 60, 56];
        
        const trace = {
            x: sleep,
            y: hrv,
            mode: 'markers',
            type: 'scatter',
            marker: {
                size: 10,
                color: '#4F46E5',
                opacity: 0.7
            },
            name: 'Sleep vs HRV'
        };
        
        // Add trend line
        const xValues = [...sleep].sort((a, b) => a - b);
        const yValues = calculateTrendLine(sleep, hrv, xValues);
        
        const trendLine = {
            x: xValues,
            y: yValues,
            mode: 'lines',
            type: 'scatter',
            line: {
                color: '#EF4444',
                width: 2,
                dash: 'dash'
            },
            name: 'Trend Line'
        };
        
        const data = [trace, trendLine];
        
        const layout = {
            xaxis: {
                title: 'Sleep Duration (hours)'
            },
            yaxis: {
                title: 'HRV'
            },
            margin: {
                l: 50,
                r: 20,
                t: 20,
                b: 50
            },
            showlegend: true,
            legend: {
                x: 0,
                y: 1
            }
        };
        
        Plotly.newPlot('scatterPlot', data, layout, {responsive: true});
    }
    
    // Helper function to calculate trend line
    function calculateTrendLine(x, y, newX) {
        // Simple linear regression
        const n = x.length;
        let sumX = 0;
        let sumY = 0;
        let sumXY = 0;
        let sumXX = 0;
        
        for (let i = 0; i < n; i++) {
            sumX += x[i];
            sumY += y[i];
            sumXY += x[i] * y[i];
            sumXX += x[i] * x[i];
        }
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        return newX.map(x => slope * x + intercept);
    }
</script>
{% endblock %}
